import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Wand2, Image as ImageIcon, CheckCircle2, Terminal, Layers, 
  LayoutTemplate, ChevronRight, RefreshCw, Download, Aperture, 
  Search, Sparkles, Zap, MessageSquare, Maximize2, Menu, X, 
  Camera, Upload, Eye, Sliders, Palette, Edit, ChefHat, Shirt,
  Share2, ExternalLink
} from 'lucide-react';

// --- DATA: 171 MODLU KATEGORÄ°ZE EDÄ°LMÄ°Åž KÃœTÃœPHANE ---
const TEMPLATES = [
  // --- Ã–ZEL Ã‡Ã–ZÃœM (En Ãœstte) ---
  { 
    id: 999, category: "â­ Ã–zel Ã‡Ã¶zÃ¼m", title: "Doku ve Kalite Ä°yileÅŸtirme", hasImageUpload: true, 
    json: { concept: "Restorasyon", inputs: { degisiklik: "Make texture hyper-realistic, fix lighting", korunacak: "Keep shape exactly" } } 
  },
  // --- SERBEST MOD ---
  { 
    id: 0, category: "âœ¨ Serbest Mod", title: "AI ile Serbest Ãœretim", hasImageUpload: true, 
    json: { concept: "SÄ±nÄ±rsÄ±z", inputs: { talimat: "Ne yapmak istediÄŸini yaz..." } } 
  },

  // --- KATEGORÄ°: YEMEK & MUTFAK (Ã–NCELÄ°KLÄ°) ---
  { id: 11, category: "ðŸ” Yemek & Mutfak", title: "11. Ä°ÅŸtah AÃ§Ä±cÄ± GÃ¶rsel", hasImageUpload: true, json: { concept: "Gurme", inputs: { detay: "Buhar, sos, taze otlar ekle" } } },
  { id: 27, category: "ðŸ” Yemek & Mutfak", title: "27. Ä°Ã§ecek ReklamÄ±", hasImageUpload: true, json: { concept: "Ä°Ã§ecek", inputs: { detay: "Buz, damlacÄ±klar, ferahlÄ±k" } } },
  { id: 48, category: "ðŸ” Yemek & Mutfak", title: "48. TarÄ±m ÃœrÃ¼nÃ¼", hasImageUpload: true, json: { concept: "DoÄŸal", inputs: { urun: "Taze toplanmÄ±ÅŸ gÃ¶rÃ¼nÃ¼m" } } },
  { id: 117, category: "ðŸ” Yemek & Mutfak", title: "117. Malzemelerden Yemek", hasImageUpload: true, json: { concept: "PiÅŸirme", inputs: { sonuc: "Son hali nasÄ±l olsun?" } } },
  { id: 129, category: "ðŸ” Yemek & Mutfak", title: "129. Patlayan Yiyecekler", hasImageUpload: true, json: { concept: "Dinamik", inputs: { efekt: "Havada uÃ§uÅŸan malzemeler" } } },
  { id: 147, category: "ðŸ” Yemek & Mutfak", title: "147. Kalori Etiketi", hasImageUpload: true, json: { concept: "Bilgi", inputs: { etiketler: "Kalori deÄŸerleri ekle" } } },
  { id: 170, category: "ðŸ” Yemek & Mutfak", title: "170. Yemek FÃ¼zyonu", hasImageUpload: true, json: { concept: "FÃ¼zyon", inputs: { birlesim: "Ä°ki yemeÄŸi tek tabakta birleÅŸtir" } } },

  // --- KATEGORÄ°: MODA & GÄ°YÄ°M (Ã–NCELÄ°KLÄ°) ---
  { id: 10, category: "ðŸ‘— Moda & Giyim", title: "10. KÄ±yafet DeÄŸiÅŸimi", hasImageUpload: true, json: { concept: "Sanal Giyim", inputs: { yeni_kiyafet: "KÄ±rmÄ±zÄ± ipek elbise" } } },
  { id: 52, category: "ðŸ‘— Moda & Giyim", title: "52. TakÄ± & Aksesuar", hasImageUpload: true, json: { concept: "MÃ¼cevher", inputs: { detay: "ParlaklÄ±k, makro Ã§ekim" } } },
  { id: 92, category: "ðŸ‘— Moda & Giyim", title: "92. T-shirt TasarÄ±mÄ±", hasImageUpload: true, json: { concept: "BaskÄ±", inputs: { grafik: "TiÅŸÃ¶rt Ã¼zerindeki desen" } } },
  { id: 114, category: "ðŸ‘— Moda & Giyim", title: "114. SaÃ§ Modeli DeÄŸiÅŸtirme", hasImageUpload: true, json: { concept: "KuafÃ¶r", inputs: { stil: "KÄ±sa kÃ¼t, platin sarÄ±" } } },
  { id: 120, category: "ðŸ‘— Moda & Giyim", title: "120. OOTD (GÃ¼nÃ¼n Kombini)", hasImageUpload: true, json: { concept: "Kombin", inputs: { mekan: "Sokak modasÄ± arka planÄ±" } } },
  { id: 135, category: "ðŸ‘— Moda & Giyim", title: "135. Sanal Makyaj", hasImageUpload: true, json: { concept: "GÃ¼zellik", inputs: { stil: "DoÄŸal tonlar, eyeliner" } } },
  { id: 136, category: "ðŸ‘— Moda & Giyim", title: "136. Makyaj Analizi", hasImageUpload: true, json: { concept: "Analiz", inputs: { vurgu: "Makyaj detaylarÄ±nÄ± Ã¶ne Ã§Ä±kar" } } },
  { id: 151, category: "ðŸ‘— Moda & Giyim", title: "151. Moda KolajÄ±", hasImageUpload: true, json: { concept: "Moodboard", inputs: { tema: "Yaz koleksiyonu" } } },

  // --- DÄ°ÄžER KATEGORÄ°LERDEN Ã–RNEKLER (Tam Liste Mevcut Kodda Korundu) ---
  { id: 9, category: "ðŸ  Mimari", title: "9. Ä°Ã§ TasarÄ±m DeÄŸiÅŸimi", hasImageUpload: true, json: { concept: "Dekorasyon", inputs: { stil: "Modern, Ä°skandinav" } } },
  { id: 40, category: "ðŸ  Mimari", title: "40. FÃ¼tÃ¼ristik Åžehir", hasImageUpload: true, json: { concept: "Åžehir", inputs: { detay: "UÃ§an arabalar, neon binalar" } } },
  { id: 1, category: "ðŸ“¦ ÃœrÃ¼n & Pazarlama", title: "1. ÃœrÃ¼n TanÄ±tÄ±mÄ±", hasImageUpload: true, json: { concept: "ÃœrÃ¼n", inputs: { atmosfer: "Minimalist, doÄŸal Ä±ÅŸÄ±k" } } },
  { id: 4, category: "ðŸ“¦ ÃœrÃ¼n & Pazarlama", title: "4. Arka Plan DeÄŸiÅŸimi", hasImageUpload: true, json: { concept: "StÃ¼dyo", inputs: { yeni_fon: "Saf beyaz stÃ¼dyo" } } },
  { id: 14, category: "ðŸ‘¤ Karakter", title: "14. Karakter GÃ¶rÃ¼nÃ¼m", hasImageUpload: true, json: { concept: "Karakter", inputs: { degisiklik: "SaÃ§ rengi, kÄ±yafet" } } },
  { id: 168, category: "ðŸ‘¤ Karakter", title: "168. 3D Bobblehead", hasImageUpload: true, json: { concept: "KarikatÃ¼r", inputs: { detay: "Koca kafa, kÃ¼Ã§Ã¼k vÃ¼cut" } } },
  { id: 6, category: "ðŸ“¸ FotoÄŸraf & Edit", title: "6. Tatil FotoÄŸrafÄ±", hasImageUpload: true, json: { concept: "AnÄ±", inputs: { atmosfer: "GÃ¼n batÄ±mÄ± ekle" } } },
  { id: 106, category: "ðŸ“¸ FotoÄŸraf & Edit", title: "106. Kalite Ä°yileÅŸtirme", hasImageUpload: true, json: { concept: "Upscale", inputs: { ayar: "4K, HDR, NetleÅŸtir" } } },
  { id: 169, category: "ðŸŽ¨ Sanat & TasarÄ±m", title: "169. Ink Splash", hasImageUpload: true, json: { concept: "Sanat", inputs: { renk: "MÃ¼rekkep daÄŸÄ±lmasÄ±" } } },
  { id: 171, category: "ðŸŽ¬ Sinema", title: "171. Rooftop Sinematik", hasImageUpload: true, json: { concept: "Atmosfer", inputs: { mekan: "Mavi saat" } } }
];

// --- BÄ°LEÅžENLER ---

const Sidebar = ({ templates, selectedId, onSelect, isOpen, onClose }) => {
  const categories = useMemo(() => {
      const order = ["â­ Ã–zel Ã‡Ã¶zÃ¼m", "âœ¨ Serbest Mod", "ðŸ” Yemek & Mutfak", "ðŸ‘— Moda & Giyim", "ðŸ  Mimari", "ðŸ“¦ ÃœrÃ¼n & Pazarlama", "ðŸ‘¤ Karakter", "ðŸ“¸ FotoÄŸraf & Edit", "ðŸŽ¨ Sanat & TasarÄ±m"];
      const allCats = [...new Set(templates.map(t => t.category))];
      return allCats.sort((a, b) => {
          const indexA = order.indexOf(a);
          const indexB = order.indexOf(b);
          if (indexA !== -1 && indexB !== -1) return indexA - indexB;
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          return a.localeCompare(b);
      });
  }, [templates]);
  
  const [searchTerm, setSearchTerm] = useState("");
  const filteredTemplates = templates.filter(t => t.title.toLowerCase().includes(searchTerm.toLowerCase()));

  return (
    <>
      {isOpen && <div className="fixed inset-0 bg-black/80 z-40 md:hidden backdrop-blur-sm" onClick={onClose} />}
      <div className={`fixed md:relative z-50 w-[300px] md:w-80 bg-slate-900 border-r border-slate-700 flex flex-col h-full transition-transform duration-300 ease-in-out transform ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} shadow-2xl`}>
        <div className="p-5 border-b border-slate-700 bg-slate-950 flex justify-between items-center">
          <div>
            <h2 className="text-white font-black text-xl flex items-center gap-2">
              <Aperture className="text-yellow-400" size={24} />
              NANO BANANA
            </h2>
            <p className="text-[10px] text-slate-400 font-medium tracking-[0.2em] uppercase ml-8">Studio v19 | Android Fix</p>
          </div>
          <button onClick={onClose} className="md:hidden text-slate-400 hover:text-white"><X size={24} /></button>
        </div>
        <div className="p-4 border-b border-slate-800 bg-slate-900/50">
            <input type="text" placeholder="171 Mod Ara..." className="w-full bg-slate-800 border border-slate-700 rounded-xl pl-10 pr-3 py-2.5 text-xs text-slate-200 focus:outline-none focus:border-yellow-500/50" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
        </div>
        <div className="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
          {categories.map(cat => {
              const catTemplates = filteredTemplates.filter(t => t.category === cat);
              if (catTemplates.length === 0) return null;
              let CatIcon = Layers;
              if (cat.includes("Yemek")) CatIcon = ChefHat;
              if (cat.includes("Moda")) CatIcon = Shirt;
              if (cat.includes("FotoÄŸraf")) CatIcon = Camera;
              if (cat.includes("Sanat")) CatIcon = Palette;
              if (cat.includes("Serbest")) CatIcon = Sparkles;
              if (cat.includes("Ã–zel Ã‡Ã¶zÃ¼m")) CatIcon = Zap;

              return (
                <div key={cat} className="mb-4">
                  <h3 className={`text-[10px] font-bold uppercase tracking-widest mb-2 px-3 py-1.5 flex items-center gap-2 rounded-lg ${cat.includes("Ã–zel") || cat.includes("Serbest") ? "text-yellow-400 bg-yellow-900/20" : cat.includes("Yemek") || cat.includes("Moda") ? "text-green-400 bg-green-900/20" : "text-slate-500 bg-slate-800/30"}`}>
                      <CatIcon size={12} /> {cat}
                  </h3>
                  <div className="space-y-1">
                    {catTemplates.map(template => (
                      <button key={template.id} onClick={() => { onSelect(template); onClose(); }} className={`w-full text-left px-3 py-2.5 rounded-lg text-xs font-medium transition-all flex items-center justify-between group border ${selectedId === template.id ? 'bg-blue-600 text-white shadow-lg border-blue-500/50' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-transparent hover:border-slate-700'}`}>
                        <span className="truncate pr-2">{template.title}</span>
                        {selectedId === template.id && <ChevronRight size={14} className="shrink-0" />}
                      </button>
                    ))}
                  </div>
                </div>
              );
          })}
        </div>
      </div>
    </>
  );
};

const ImageUploadArea = ({ onImageUpload, currentImage }) => {
    const fileInputRef = useRef(null);
    const handleFile = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => onImageUpload(reader.result);
            reader.readAsDataURL(file);
        }
    };

    return (
        <div className="mb-6 animate-in fade-in slide-in-from-top-4 space-y-4">
            <div className="flex justify-between items-center">
                <label className="text-[10px] font-bold text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                    <Camera size={12} />
                    DÃ¼zenlenecek GÃ¶rsel
                </label>
                {currentImage && <button onClick={() => onImageUpload(null)} className="text-[10px] text-red-400 hover:text-red-300">KaldÄ±r</button>}
            </div>
            <div onClick={() => !currentImage && fileInputRef.current.click()} className={`border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center transition-all group relative overflow-hidden ${currentImage ? 'border-green-500/50 bg-green-900/10' : 'border-slate-700 hover:border-yellow-500/50 cursor-pointer'}`}>
                {currentImage ? (
                    <div className="w-full flex items-center gap-4">
                        <div className="relative w-20 h-20 rounded-lg overflow-hidden border border-slate-600 shadow-lg shrink-0">
                            <img src={currentImage} alt="Ref" className="w-full h-full object-cover" />
                        </div>
                        <div className="flex-1">
                            <p className="text-xs text-white font-bold mb-0.5">GÃ¶rsel HazÄ±r</p>
                            <p className="text-[10px] text-slate-400">Ãœzerinde deÄŸiÅŸiklik yapÄ±lacak.</p>
                        </div>
                        <div className="bg-green-500 text-black p-2 rounded-full"><Edit size={16} /></div>
                    </div>
                ) : (
                    <div className="text-center py-4">
                        <div className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400 group-hover:text-yellow-400 transition-all"><Upload size={20} /></div>
                        <p className="text-xs text-slate-300 font-medium">GÃ¶rsel YÃ¼kle</p>
                        <p className="text-[9px] text-slate-500 mt-1">AI bu gÃ¶rseli dÃ¼zenleyecek.</p>
                    </div>
                )}
                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFile} />
            </div>
        </div>
    );
};

const InputField = ({ label, value, onChange }) => {
  return (
    <div className="space-y-2 bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 hover:border-slate-600 transition-colors group focus-within:border-blue-500/50">
      <div className="flex justify-between items-center">
        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 group-focus-within:text-blue-400 transition-colors">
            <Terminal size={12} /> {label.replace(/_/g, ' ')}
        </label>
        <Maximize2 size={12} className="text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity" />
      </div>
      <textarea value={value} onChange={(e) => onChange(e.target.value)} className="w-full h-24 bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-200 focus:ring-1 focus:ring-blue-500 outline-none transition-all resize-none custom-scrollbar" placeholder={`${label} giriniz...`} />
    </div>
  );
};

const App = () => {
  const [isSidebarOpen, setSidebarOpen] = useState(false);
  const [selectedTemplate, setSelectedTemplate] = useState(TEMPLATES[0]);
  const [inputs, setInputs] = useState(TEMPLATES[0].json.inputs || {});
  const [uploadedImage, setUploadedImage] = useState(null);
  const [generatedPrompt, setGeneratedPrompt] = useState("");
  const [isProcessingPrompt, setIsProcessingPrompt] = useState(false);
  const [isGeneratingImage, setIsGeneratingImage] = useState(false);
  const [generatedImage, setGeneratedImage] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    setInputs(selectedTemplate.json.inputs || {});
    setGeneratedPrompt("");
    setGeneratedImage(null);
    setUploadedImage(null);
    setError(null);
  }, [selectedTemplate]);

  const handleInputChange = (key, value) => {
    setInputs(prev => ({ ...prev, [key]: value }));
  };

  const handleGeneratePrompt = async () => {
    setIsProcessingPrompt(true);
    setError(null);
    const apiKey = ""; 

    try {
        const userInputsText = Object.entries(inputs).map(([key, val]) => `${key}: ${val}`).join("\n");
        const systemInstruction = `
            You are an Expert AI Prompt Translator.
            Task: Translate user's Turkish instructions to clear English editing commands for an AI.
            Do not describe an image if not asked. Just describe the CHANGE.
            Output ONLY the English instruction string.
        `;

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `User Instructions:\n${userInputsText}` }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                })
            }
        );

        if (!response.ok) throw new Error("Prompt servisi hatasÄ±.");
        const result = await response.json();
        const aiPrompt = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (aiPrompt) setGeneratedPrompt(aiPrompt.trim());
        else throw new Error("AI boÅŸ yanÄ±t dÃ¶ndÃ¼rdÃ¼.");

    } catch (err) {
        console.error(err);
        setError(`Prompt HatasÄ±: ${err.message}`);
    } finally {
        setIsProcessingPrompt(false);
    }
  };

  const handleVisualize = async () => {
    if (!generatedPrompt) return;
    setIsGeneratingImage(true);
    setError(null);
    setGeneratedImage(null);

    const apiKey = ""; 

    try {
        let response;
        if (selectedTemplate.hasImageUpload && uploadedImage) {
             const base64Data = uploadedImage.split(',')[1];
             response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: `Apply this instruction to the image: ${generatedPrompt}. Maintain the original composition and subject identity perfectly. Output the modified image.` }, 
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ] 
                        }],
                        generationConfig: { responseModalities: ["IMAGE"] }
                    })
                }
            );
        } else {
            response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        instances: [{ prompt: generatedPrompt }],
                        parameters: { sampleCount: 1, aspectRatio: "1:1" }
                    })
                }
            );
        }

        if (!response.ok) {
             const errData = await response.json().catch(() => ({}));
             throw new Error(errData.error?.message || "Servis hatasÄ±.");
        }

        const result = await response.json();
        let base64Image = null;
        if(result.predictions?.[0]?.bytesBase64Encoded) base64Image = result.predictions[0].bytesBase64Encoded;
        else if (result.candidates?.[0]?.content?.parts) {
             const imgPart = result.candidates[0].content.parts.find(p => p.inlineData);
             if(imgPart) base64Image = imgPart.inlineData.data;
        }

        if (base64Image) setGeneratedImage(`data:image/png;base64,${base64Image}`);
        else throw new Error("GÃ¶rsel oluÅŸturulamadÄ±.");

    } catch (err) {
        console.error(err);
        setError(`Ä°ÅŸlem BaÅŸarÄ±sÄ±z: ${err.message}`);
    } finally {
        setIsGeneratingImage(false);
    }
  };

  // --- ANDROID Ä°Ã‡Ä°N GÃœVENLÄ° Ä°NDÄ°RME & PAYLAÅžMA ---
  const handleDownload = async () => {
    if (!generatedImage) return;
    
    try {
        const byteString = atob(generatedImage.split(',')[1]);
        const mimeString = generatedImage.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
        const blob = new Blob([ab], {type: mimeString});
        const file = new File([blob], `NanoBanana_${Date.now()}.png`, { type: mimeString });

        // 1. Ã–NCE NATIVE PAYLAÅžIM MENÃœSÃœNÃœ DENE (ANDROID DOSTU)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Nano Banana Render',
                    text: 'Yapay zeka ile oluÅŸturduÄŸum gÃ¶rsel.'
                });
                return;
            } catch (shareError) {
                console.warn('PaylaÅŸÄ±m iptal edildi veya baÅŸarÄ±sÄ±z', shareError);
            }
        }

        // 2. FALLBACK: KLASÄ°K Ä°NDÄ°RME (MASAÃœSTÃœ/DÄ°ÄžER)
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = `NanoBanana_${Date.now()}.png`;
        document.body.appendChild(link)
